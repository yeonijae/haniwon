# 한약 처방-탕전-배송 워크플로우 구현 계획

> 작성일: 2026-01-24
> 상태: 전체 완료 (Phase A ~ F)

---

## 목표

선결제 → 처방 → 탕전 → 배송 전 과정을 팀원 모두가 투명하게 확인하고, 누락/지연을 방지

---

## 워크플로우 개요

```
[데스크 - 상담/결제]
① 탕전슬롯 확인 → ② 탕전일 확정 → ③ 수령방식 결정 → ④ 환자 안내
        │
        ├──────────────────┬────────────────────┐
        ▼                  ▼                    ▼
[담당원장 - 처방입력]  [탕전실 - 탕전]    [CS - 배송/해피콜]
D-2: 리마인더         처방확인→탕전        수령안내→송장→해피콜
D-1: 긴급알림         미입력시 요청
```

---

## Phase A: DB 구조 (완료 ✅)

### A-1. 탕전 슬롯 테이블

```sql
CREATE TABLE decoction_slots (
  id SERIAL PRIMARY KEY,
  slot_date DATE NOT NULL UNIQUE,
  total_capacity INTEGER DEFAULT 100,
  reserved_capacity INTEGER DEFAULT 0,
  is_available BOOLEAN DEFAULT true,
  memo TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### A-2. cs_herbal_packages 확장

```sql
-- 담당원장
ALTER TABLE cs_herbal_packages ADD COLUMN doctor_id INTEGER;
ALTER TABLE cs_herbal_packages ADD COLUMN doctor_name TEXT;

-- 탕전 관련
ALTER TABLE cs_herbal_packages ADD COLUMN decoction_slot_id INTEGER;
ALTER TABLE cs_herbal_packages ADD COLUMN decoction_date DATE;
ALTER TABLE cs_herbal_packages ADD COLUMN decoction_status TEXT DEFAULT 'pending';
ALTER TABLE cs_herbal_packages ADD COLUMN decoction_started_at TIMESTAMP;
ALTER TABLE cs_herbal_packages ADD COLUMN decoction_completed_at TIMESTAMP;

-- 처방 관련
ALTER TABLE cs_herbal_packages ADD COLUMN prescription_id INTEGER;
ALTER TABLE cs_herbal_packages ADD COLUMN prescription_status TEXT DEFAULT 'pending';
ALTER TABLE cs_herbal_packages ADD COLUMN prescription_due_date DATE;
ALTER TABLE cs_herbal_packages ADD COLUMN prescription_requested_at TIMESTAMP;
ALTER TABLE cs_herbal_packages ADD COLUMN prescription_request_count INTEGER DEFAULT 0;

-- 복용법
ALTER TABLE cs_herbal_packages ADD COLUMN dosage_instruction TEXT;
ALTER TABLE cs_herbal_packages ADD COLUMN dosage_status TEXT DEFAULT 'pending';

-- 배송 관련
ALTER TABLE cs_herbal_packages ADD COLUMN delivery_method TEXT;
ALTER TABLE cs_herbal_packages ADD COLUMN delivery_date DATE;
ALTER TABLE cs_herbal_packages ADD COLUMN delivery_status TEXT DEFAULT 'pending';
ALTER TABLE cs_herbal_packages ADD COLUMN tracking_number TEXT;
ALTER TABLE cs_herbal_packages ADD COLUMN delivery_completed_at TIMESTAMP;
ALTER TABLE cs_herbal_packages ADD COLUMN pickup_notified_at TIMESTAMP;
ALTER TABLE cs_herbal_packages ADD COLUMN shipping_notified_at TIMESTAMP;
```

### A-3. prescriptions 확장

```sql
ALTER TABLE prescriptions ADD COLUMN herbal_package_id INTEGER;
ALTER TABLE prescriptions ADD COLUMN dosage_instruction TEXT;
```

---

## Phase B: 선결제 등록 화면 개선 (완료 ✅)

### 완료 항목
- ✅ 탕전일 선택 UI (드롭다운으로 예약 가능한 슬롯 표시)
- ✅ 수령방식 선택 (내원/시내/시외 버튼)
- ✅ 담당원장 선택 (환자 주치의 자동 설정)
- ✅ 탕전 슬롯 예약 시 용량 자동 차감

### 변경된 파일
- `src/modules/cs/components/RegisterModal.tsx` - UI 추가
- `src/modules/cs/lib/decoctionApi.ts` - 슬롯 관리 API
- `src/modules/cs/types.ts` - 타입 정의 확장
- `src/modules/cs/styles/cs.css` - 스타일 추가

### 미완료
- ⬜ 환자 안내 멘트 자동 생성 (Phase F에서 카카오톡 연동 시 구현)

---

## Phase C: 진료관리 대시보드 (완료 ✅)

### 완료 항목
- ✅ 처방 대기 목록 컴포넌트 (담당원장별 필터링)
- ✅ D-Day, D-1, D-2 긴급도 배지 표시
- ✅ 처방 입력 모달 (처방 선택 + 복용법 입력)
- ✅ 패키지-처방 연결 기능

### 변경된 파일
- `src/modules/doctor-pad/components/PrescriptionPendingList.tsx` - 처방 대기 목록
- `src/modules/doctor-pad/components/PrescriptionInputModal.tsx` - 처방 입력 모달
- `src/modules/doctor-pad/DoctorPadApp.tsx` - 대시보드에 통합
- `src/modules/cs/lib/decoctionApi.ts` - 원장별 조회 API
- `src/modules/inventory/api/prescriptions.ts` - 처방 생성 API 확장

---

## Phase D: 탕전실 화면 (완료 ✅)

### 완료 항목
- ✅ 오늘 탕전 목록 (날짜 선택 가능)
- ✅ 탕전 상태별 통계 표시 (대기/진행중/완료)
- ✅ 처방/복용법 미입력 표시 (빨간색 강조)
- ✅ 원장에게 처방 요청 버튼 → 잔디 알림
- ✅ 탕전 시작/완료 상태 변경
- ✅ 1분마다 자동 갱신

### 변경된 파일
- `src/modules/inventory/pages/HerbalDecoctionManager.tsx` - 탕전 관리 화면
- `src/modules/inventory/InventoryApp.tsx` - 메뉴 추가 (한약탕전)

---

## Phase E: 배송 관리 (완료 ✅)

### 완료 항목
- ✅ 배송/수령 대기 패키지 목록 (탕전 완료 → 배송 대기)
- ✅ 수령방식별 필터링 (내원/시내배송/택배)
- ✅ 내원 수령: 수령 안내 버튼 → 알림 발송 기록
- ✅ 배송: 송장번호 등록 + 배송 알림 발송
- ✅ 수령/배송 완료 처리
- ✅ 오늘 완료 목록 표시

### 변경된 파일
- `src/modules/inventory/pages/HerbalDeliveryManager.tsx` - 배송 관리 화면
- `src/modules/cs/lib/decoctionApi.ts` - 배송 API 추가
- `src/modules/inventory/InventoryApp.tsx` - 메뉴 추가 (한약배송)

### 미완료
- ⬜ 카카오톡 알림 연동 (Phase F에서 자동화 시 구현)

---

## Phase F: 자동화 (완료 ✅)

### 완료 항목
- ✅ D-2, D-1, D-Day 처방 리마인더 배치
  - 원장별 그룹핑 후 잔디 알림 발송
  - 긴급도별 색상 구분 (D-2: 초록, D-1: 주황, D-Day: 빨강)
- ✅ 해피콜 자동 등록
  - 배송/수령 완료 시 다음날 해피콜 일정 자동 생성
  - 복약 시작 시 7일차 해피콜 일정 자동 생성
- ✅ 상태 자동 전이
  - 탕전일 도래 시 pending → ready 자동 전환
  - 지연 패키지 알림 발송
- ✅ 자동화 대시보드
  - 현황 모니터링 (D-2/D-1/D-Day/지연 건수)
  - 수동 배치 실행 버튼
  - 실행 결과 표시

### 변경된 파일
- `src/modules/cs/lib/automationApi.ts` - 자동화 배치 함수
- `src/modules/inventory/pages/HerbalAutomationDashboard.tsx` - 자동화 대시보드
- `src/modules/inventory/pages/HerbalDeliveryManager.tsx` - 해피콜 자동 등록 연동
- `src/modules/inventory/InventoryApp.tsx` - 메뉴 추가 (자동화)

### 자동 실행 권장
- 매일 오전 8시, 오후 2시에 배치 실행 권장
- 현재는 수동 실행, 추후 서버 cron job 연동 가능

---

## 진행 상태

| Phase | 상태 | 시작일 | 완료일 |
|-------|------|--------|--------|
| Phase A | ✅ 완료 | 2026-01-24 | 2026-01-24 |
| Phase B | ✅ 완료 | 2026-01-24 | 2026-01-24 |
| Phase C | ✅ 완료 | 2026-01-24 | 2026-01-24 |
| Phase D | ✅ 완료 | 2026-01-24 | 2026-01-24 |
| Phase E | ✅ 완료 | 2026-01-24 | 2026-01-24 |
| Phase F | ✅ 완료 | 2026-01-24 | 2026-01-24 |
