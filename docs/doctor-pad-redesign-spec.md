# 닥터패드 리디자인 시방서

> 작성일: 2024-12-19
> 상태: 설계 단계

---

## 1. 개요

### 1.1 목적
원장이 자신의 환자 현황과 해야 할 액팅을 한눈에 파악하고, 액팅 시간을 기록할 수 있는 대시보드

### 1.2 타겟 디바이스
- **주 사용**: iPad Mini 5 (7.9인치, 2048x1536)
- **보조 사용**: PC 브라우저

### 1.3 관련 파일
- `src/modules/doctor-pad/DoctorPadApp.tsx`
- `src/modules/acting/api.ts`
- `src/modules/treatment/components/TreatmentView.tsx`

---

## 2. 액팅 분류 체계

### 2.1 액팅 종류 및 장소

| 액팅명 | 장소 | 수행자 | 소요시간 | 비고 |
|--------|------|--------|----------|------|
| **자침** | 침구실(베드) | 원장 | 1~3분 | 원장이 침 놓는 시간 |
| **유침** | 침구실(베드) | 환자(대기) | 10~15분 | 침 맞고 전침 걸어놓는 시간, 베드 타이머 관리 |
| **추나** | 진료실 | 원장 | - | |
| **초음파** | 진료실 | 원장 | - | |
| **약상담** | 진료실 | 원장 | - | |

### 2.2 기존 "침" → "자침/유침" 분리

```
[기존]
베드 배정 → "침" 액팅 생성 → 원장 시작/종료 → 끝

[변경]
베드 배정 → "자침" 액팅 생성 (원장용)
         → 원장 "자침 시작" 클릭
         → 원장 "자침 종료" 클릭 (1~3분 기록)
         → 베드에서 "유침" 타이머 자동 시작 (10~15분)
         → 유침 완료 후 다음 치료 진행
```

### 2.3 마이그레이션 필요 사항
- `acting_queue` 테이블의 기존 "침" → "자침"으로 변경
- `ACTING_TREATMENT_NAMES` 상수 업데이트
- 베드 치료 항목 표시 로직 변경

---

## 3. 화면 구성

### 3.1 원장 대시보드 레이아웃

```
┌─────────────────────────────────────────────────────────────────┐
│  임원장                                              [↻] [닫기] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📋 내 액팅 대기 (3)                                            │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                           │
│  │ 홍길동  │ │ 김철수  │ │ 이영희  │  ← 클릭 시 차트 모달     │
│  │  자침   │ │  추나   │ │ 약상담  │                           │
│  └─────────┘ └─────────┘ └─────────┘                           │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  🛏️ 내 환자 치료 현황                                          │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ 베드    환자      현재치료         남은시간    다음치료   │ │
│  ├───────────────────────────────────────────────────────────┤ │
│  │ 1-2    홍길동    자침 (원장진행)     -         유침→추나  │ │
│  │ 1-4    박민수    유침              08:30       약침       │ │
│  │ 2-1    최지은    추나 (원장진행)     -         완료       │ │
│  │ 2-3    정수현    초음파            03:20       침        │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ⏱️ 진행 중인 내 액팅                                           │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  홍길동 - 자침      01:23 경과        [종료]               ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 3개 섹션 설명

| 섹션 | 설명 | 데이터 소스 |
|------|------|------------|
| 📋 내 액팅 대기 | 내가 해야 할 액팅 목록 | PostgreSQL `acting_queue` (doctor_id=나, status='waiting') |
| 🛏️ 내 환자 치료 현황 | 내 담당 환자들이 베드에서 받는 치료 | PostgreSQL `treatment_rooms` (doctor_name=나) |
| ⏱️ 진행 중인 내 액팅 | 현재 진행 중인 액팅 (시간 카운팅) | PostgreSQL `acting_queue` (doctor_id=나, status='in_progress') |

### 3.3 "내 환자" 기준
- **접수된 담당의** 기준 (오늘만 담당의가 다를 수 있음)
- `treatment_rooms.doctor_name` 또는 `waiting_queue.doctor` 필드

---

## 4. 환자 차트 모달

### 4.1 레이아웃

```
┌─────────────────────────────────────────────────────────────────┐
│  홍길동 (20240001)                                      [닫기] │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              [ 자침 시작 ]     ← 액팅 시작 버튼            ││
│  └─────────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────────┤
│  [메모]  [진료내역]  [수납내역]  [오늘치료]     ← 탭 메뉴      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ● 주치의메모                                                   │
│  허리 디스크 L4-5, 침 자극 강하게 요청                          │
│                                                                 │
│  ● 간호사메모                                                   │
│  혈압 주의 (140/90), 당뇨약 아침 복용                           │
│                                                                 │
│  ● 주소증                                                       │
│  요통, 좌골신경통, 우측 다리 저림                               │
│                                                                 │
│  ● 진료메모1 / 진료메모2                                        │
│  12/15 - 침 후 통증 50% 감소                                   │
│                                                                 │
│  ● 기타메모                                                     │
│  ...                                                            │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  현재 베드: 1-2 | 치료: 자침(대기) → 유침 → 추나               │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 탭 구성

| 탭 | 데이터 소스 | 내용 |
|----|------------|------|
| 메모 | MSSQL | 주치의메모, 간호사메모, 주소증, 진료메모1/2, 기타메모 |
| 진료내역 | MSSQL | 최근 3건 진료 세부정보 (날짜, 처치, 진단 등) |
| 수납내역 | MSSQL | 최근 3건 수납내역 (날짜, 금액, 항목) |
| 오늘치료 | PostgreSQL | patient_default_treatments, 오늘 치료 항목/약침 정보 |

### 4.3 액팅 진행 중 상태

```
┌─────────────────────────────────────────────────────────────────┐
│  ┌─────────────────────────────────────────────────────────────┐│
│  │   🔴 자침 진행중   01:23        [ 자침 종료 ]              ││
│  └─────────────────────────────────────────────────────────────┘│
```

---

## 5. 액팅 플로우

### 5.1 원장 액팅 흐름 (자침/추나/초음파/약상담)

```
1. 대시보드에서 "내 액팅 대기" 카드 클릭
   └→ 환자 차트 모달 열림 (카운팅 안함, 차트만 읽기)

2. 모달 상단 "[자침 시작]" 버튼 클릭
   └→ acting_queue.status = 'in_progress'
   └→ acting_queue.started_at = 현재시간
   └→ 시간 카운팅 시작 (화면에 표시)

3. 액팅 진행 중 화면에서 경과 시간 실시간 표시

4. "[자침 종료]" 버튼 클릭
   └→ acting_queue.status = 'completed'
   └→ acting_queue.completed_at = 현재시간
   └→ acting_queue.duration_sec = 경과시간
   └→ acting_records에 통계용 기록 저장
```

### 5.2 자침 → 유침 자동 전환 흐름

```
원장이 "자침 종료" 클릭
   │
   ├→ acting_queue에 자침 완료 기록
   │
   └→ treatment_rooms의 해당 환자 베드에서:
      ├→ 현재 치료 항목 "자침" → "유침"으로 변경
      ├→ 유침 타이머 자동 시작 (10~15분)
      └→ 치료실 화면에서 "유침" 진행 중으로 표시
```

### 5.3 베드 치료 항목 표시 로직

| 상태 | 베드 표시 | 설명 |
|------|----------|------|
| 원장 자침 전 | "자침" (대기) | 원장 액팅 대기 중 |
| 원장 자침 중 | "자침" (진행) | 원장이 침 놓는 중 |
| 원장 자침 완료 | "유침" (진행) | 환자 유침 중, 타이머 작동 |
| 유침 완료 | 다음 치료로 이동 | |

---

## 6. 데이터 구조

### 6.1 acting_queue 테이블 (기존)

```sql
acting_queue (
  id, patient_id, patient_name, chart_no,
  doctor_id, doctor_name, acting_type,  -- "자침", "추나", "초음파", "약상담"
  order_num, status, source, source_id, memo,
  created_at, started_at, completed_at, duration_sec, work_date
)
```

### 6.2 MSSQL 환자 정보 필드

| API 필드명 | MSSQL 컬럼 | 설명 |
|-----------|-----------|------|
| doctor_memo | NOTEFORDOC | 진료메모1 (주치의메모) |
| nurse_memo | NOTEFORNURSE | 간호사메모 |
| main_disease | MAINDISEASE | 주소증 |
| main_doctor | MAINDOCTOR | 담당 원장 |
| treat_type | TreatCurrent | 진료메모2? |
| etc_memo | ETCMemo | 기타메모 |

### 6.3 원장 ID 매핑 (MSSQL doctor_id)

| 원장 | MSSQL ID | 호칭 |
|------|----------|------|
| 김대현 | 3 (doctor_3) | 김원장 |
| 강희종 | 1 (doctor_1) | 강원장 |
| 임세열 | 13 (doctor_13) | 임원장 |
| 전인태 | 15 (doctor_15) | 전원장 |

---

## 7. 구현 작업 목록

### 7.1 Phase 1: 데이터/API 준비
- [ ] MSSQL API 확장: 진료메모2, 주소증, 기타메모 필드 추가
- [ ] MSSQL API: 최근 3건 수납내역 조회 엔드포인트
- [ ] "침" → "자침" 마이그레이션 (acting_queue, ACTING_TREATMENT_NAMES)

### 7.2 Phase 2: 닥터패드 UI 리디자인
- [ ] 원장 대시보드 레이아웃 (3섹션)
- [ ] 환자 차트 모달 (4탭)
- [ ] 액팅 시작/종료 버튼 및 타이머

### 7.3 Phase 3: 자침→유침 연동
- [ ] 자침 종료 시 베드에서 유침 자동 시작 로직
- [ ] 치료실 베드 표시 로직 변경 (자침/유침 구분)

### 7.4 Phase 4: 테스트 및 최적화
- [ ] iPad Mini 5 레이아웃 테스트
- [ ] PC 레이아웃 테스트
- [ ] 폴링 주기 최적화

---

## 8. 미결정 사항

1. ~~자침 → 유침 전환 방식~~ → **A) 자동 전환으로 결정**
2. ~~기존 "침" 마이그레이션~~ → **"자침"으로 변경 결정**
3. 유침 기본 시간: 10분? 15분? (설정 가능하게?)
4. 약상담 시 처방 연동 필요 여부

---

## 9. 변경 이력

| 날짜 | 내용 |
|------|------|
| 2024-12-19 | 초안 작성 |
| 2024-12-19 | 침 → 자침/유침 분리 결정 |
| 2024-12-19 | 자침 종료 시 유침 자동 시작으로 결정 |
